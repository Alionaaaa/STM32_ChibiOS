# Потоки - диспетчеризация 

## Описание

**Диспетчер (scheduler)** - абстрактная сущность в ОСРВ, которая обеспечивает распределение работ потоков в самой системе. Он как начальник отдела, который распределяет инструменты (в одноядерной системе инструмент один) между работниками в зависимости от различных состояний, их квалификаций (приоритета) или других факторов. Таким образом, работник получает инструмент и начинает работать. Остальные жду, когда им выдадут рабочее время (время CPU).

Относительно ChibiOS можно выделить два типа диспетчеризации:
+ кооперативная (cooperative)
+ карусельная (round-robin).

Сначала предлагается обсудить их концептуально.

Оба метода диспетчеризации распространяются на потоки с равным приоритетом, так как для потоков с разными приоритетами работает более жесткое правило приоритетов, несмотря на метод диспетчеризации.

### Кооперативная диспетчеризация

<ins>Принцип работы</ins> - "Поток работает столько, сколько ему необходимо"

Из правила работа происходит таким образом, что из двух потоков на равном приоритете один будет работать до тех пор, пока не вызовет одну из функций, которая передаст управление диспетчеру. Диспетчер в свою очередь передаст управление второму потоку, который находился в состоянии ожидания работы.

Для данной методики подойдет данный график

<p align="center">
<img src="http://www.playembedded.org/blog/wp-content/uploads/2016/10/Example-1-threads-flow.png">
</p>

### Карусельная диспетчеризация

<ins>Принцип работы</ins> - "Поток работает выделенное ему время"

Данной методике свойственно задание конкретного интервала времени (квант времени), в течении которого он может выполнять работу. При превышении данного интервала диспетчер переводит поток в очередь (при этом сам поток в состоянии готовности), а следующий поток в готовом состоянии переходит к работе. На изображении представлен график потоков на равном приоритете с квантом времени 50 мс.

<p align="center">
<img src="http://www.playembedded.org/blog/wp-content/uploads/2016/10/Example-3-threads-flow.png">
</p>

## Программное использование

Теперь перейдем к управлению в программе. Сам диспетчер работает на основе определенных правил, которые устанавливает разработчик. В данном посте предлагается рассмотреть выбор методики диспетчеризации. Управление приоритетами рассмотрено в отдельном посте.

Для установки метода диспетчеризации используется константа конфигурации в файле-заголовке `chconf.h`.

```
CH_CFG_TIME_QUANTUM
```

При установке данной константе значения 0 используется кооперативная диспетчеризация. Любое положительное значение устанавливает карусельную диспетчеризацию, а само значение означает количество тиков системного таймер, в течении которого поток работает (квант времени). Так, например, если частота системного таймера (`CH_CFG_ST_FREQUENCY`) равна 1000 (1 кГц). При установке `CH_CFG_TIME_QUANTUM` значения 70 квант времени потока будет равен 70 мс (70/1000 = 0.07 с = 70 мс).

```
void chThdYield (void)
```

Данная функция используется, в основном, в кооперативной диспетчеризации. Ее назначение - передача управления диспетчеру для дальнейшего распределения времени CPU. Сам поток переходит в состояние готовности (при этом попадая в очередь потоков). Если функция была вызвана, но в очереди готовых потоков нет, то данный поток сразу продолжает работу.

## Рекомендации

Не забывать про `chThdYield()` в кооперативной диспетчеризации. Часто ее выпускают из виду и при этом поток забирает очень много времени, что увеличивает джиттер (jitter) системы. В случае с карусельной диспетчеризацией функция `chThdYield()` не имеет такого большого значения, так как все потоки на равном приоритете равномерно распределяют время.

Тип диспетчеризации выбирается исходя из выполняемых потоками задач. Если задачи поддаются равномерному распределению, то рекомендуется использовать карусельный метод. При неравномерном распределении можно обратиться к кооперативному методу с выдачей потоками управления диспетчеру, где это возможно. При этом данная рекомендация является рекомендацией и конечное решение принимает сам разработчик.

Помимо функции `chThdYield()` огромное (да почти все) количество функций взаимодействую с диспетчером, поэтому рекомендуется пользоваться ими и держать общение с диспетчером в хорошем состоянии.

### Полезные ссылки
1. [Книга](http://www.chibios.org/dokuwiki/doku.php?id=chibios:book:kernel_scheduler)
2. [Доки](http://chibios.sourceforge.net/docs3/rt/group__scheduler.html)
