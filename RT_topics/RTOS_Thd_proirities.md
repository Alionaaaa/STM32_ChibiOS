# Потоки - приоритеты

## Описание

Наверное, данный пост должен быть одним из первых в теме "Потоки". Понятие приоритетов известно всем из жизни. Также понятно, что означает фраза

	Высокий приоритет

Причины, почему что-либо имеет высокий/низкий приоритет, обычно остаются за кадром, когда рассматривается вопрос того, что из этого следует. Какое-то дело может иметь высокий приоритет, поэтому все бросаются на его выполнение, несмотря на то, что этому поспособствовало.

Так и при организации потоков, здесь правило простое.

Введем понятие **вытеснения (preemption)** одного потока другим - ситуация, когда вытесняющий поток прерывает выполнение вытесняемого потока с дальнейшим восстановлением. Одной из наиболее распространенных причин такой ситуации может быть как раз система приоритетов в ОСРВ. Если поток с более высоким приоритетом готов к выполнению (о состояниях в другом посте), чем приоритет работающего потока, то первый вытесняет второго, выполняет работу и затем возвращает управление прерванному потоку.

Ситуация немного усложняется, когда поток со средним приоритетом прервал поток с низким приоритетом, а его прервал поток с высоким приоритетом. В описанной ситуации работает правило *вложенности*. Высокий приоритет закончит работу, средний приоритет также закончит работу и управление вернется к низкому приоритету.

Так что **правило**:

	Поток с более высоким приоритетом вытесняет поток с меньшим приоритетом.

В данном правиле сравнение производится с помощью строго знака неравенства, так как на потоки с одинаковым приоритетом данное правило не распространяется. Вот так просто можно разграничить значимость потоков по признаку приоритетности.

Для наглядности график:

<p align="center">
<img src="http://www.playembedded.org/blog/wp-content/uploads/2016/10/Example-1-threads-flow.png">
</p>

В нем показаны основные потоки программы, в которой разработчиком создан только один поток. Позже будут описаны особенности работы программы в ОСРВ ChibiOS. Но вернемся к графику, здесь можно видеть, что ось Y указывает относительно значение приоритета, ось X - время.

Моменты 1-2 показывают создание потока `Thread1` и мгновенный переход к его выполнению, так как поток был создан - перешел в состояние готовности. Таким образом момент 2 - работа высокоприоритетного потока. Далее по завершении (переход в сон), поток возвращает управление потоку `main`.

По завершении выполнения `main` передается управление низкоприоритетному потоку `idle`. Далее моменты 4-5, 6-7-8, 10-11, 12-13 показывают вытеснения потоками с большими приоритетами, по отношению к работающему потоку.

## Программное использование

А теперь ближе к программе и ChibiOS.
В указанной системе существует пять макро-определений (констант), которые задают абсолютные значения приоритетов в системе. На них можно посмотреть на [данной странице в разделе "Priority Levels"](http://chibios.sourceforge.net/docs3/rt/concepts.html).

+ `IDLEPRIO`, наименьший приоритет в системе, назначен потоку `idle`.
+ `LOWPRIO`, наименьший приоритет, который может установить разработчик потоку.
+ `NORMALPRIO`, центральный (средний) приоритет, рекомендован в качестве точки отсчета приоритетов для относительного задания уровней. По-умолчанию, назначен потоку main. Для задания относительного приоритета можно использовать нотации `NORMALPRIO+1`, `NORMALPRIO-4`.
+ `HIGHPRIO`, наибольший приоритет, который может установить разработчик потоку.
+ `ABSPRO`, наибольший приоритет в системе.

В ChibiOS существует правило, по которому при выполнение `chSysInit()` происходит создание двух потоков: `main` и `idle`. Поток `main` всегда имеет значение приоритета `NORMALPRIO`, поток `idle` - `IDLEPRIO`.

При создании потоков рекомендуется пользоваться константами абсолютных уровней приоритетов, перечисленных выше, в особенности `NORMALPRIO`, так как сама ОСРВ предполагает свойство переносимости кода, при этом на платформе STM32 значение `NORMALPRIO` установлено `128`, а при переходе на другую платформу (например, AVR) константа может иметь другое абсолютное значение. По этой причине желательно использование относительных значений с константой `NORMALPRIO`.

Сами по себе приоритеты являются сущностью, которая управляет дальнейшим поведением диспетчера при распределении потоков. Задается приоритет потоку одним из аргументов функции `chThdCreateStatic()` при создании потока. Далее поток сохраняет установленный приоритет. При этом существуют функции получения значения и установки нового приоритета потока.

В ChibiOS значение приоритета имеет тип `tprio_t`.

```
tprio_t chThdSetPriority (tprio_t newprio)
```

Установка нового приоритета потоку.

**Return:**
	предыдущий установленный приоритет потока.

```
tprio_t chThdGetPriorityX (void)
```

Получение нынешнего приоритета потока.

**Return:**
	 приоритет потока.

## Рекомендации

Как и было сказано ранее, рекомендовано использование относительных значений приоритетов потоков. Также, сами по себе уровни приоритета являются показателями важности выполняемой потоком задачи.

### Полезные ссылки
Не сказать, что ссылки идеально подходят, но что есть :grinning: 

1. [Книга](http://www.chibios.org/dokuwiki/doku.php?id=chibios:book:kernel_threading#priority_management)
2. [Доки](http://chibios.sourceforge.net/docs3/rt/group__scheduler.html)